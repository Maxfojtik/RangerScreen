#include <U8g2lib.h>
#include <U8x8lib.h>
//#include <TinyGPS++.h>
#include <EEPROM.h>
#include <Encoder.h>

#define OUTPUT0 3
#define OUTPUT1 4
#define OUTPUT2 5
#define OUTPUT3 6
#define LATCH_PIN 21

#define VOLTAGE_INPUT A6
#define ILL_INPUT A1
#define ENCODER_PUSH 12
#define ENCODER_A 11
#define ENCODER_B 10
#define ENCODER_PUSH 12
#define BED_INPUT A8
#define BED_SWITCH A9
#define SWITCH_A 2
#define SWITCH_B 9

#define NUMBER_OUTPUTS 4
byte outs[NUMBER_OUTPUTS];

#define BTATPIN 14
#define BTSerial Serial1
#define ATBAUD 38400
#define COMBAUD 9600


U8G2_SSD1306_128X32_UNIVISION_F_HW_I2C u8g2l(U8G2_R2);
U8G2_SSD1306_128X32_UNIVISION_F_2ND_HW_I2C u8g2r(U8G2_R0);

#define REASON_IGNITION 0
#define REASON_TAILGATEDOWN 1
#define REASON_TAILGATESW 2
#define REASON_SWITCHA 3
#define REASON_SWITCHB 4

#define loopTime 20

//TinyGPSPlus gps;
Encoder encoder(ENCODER_A, ENCODER_B);
#define numAvgs 5
float voltAvg[numAvgs];
byte voltAvgIndex = 0;
#define numGraphPix 128
byte voltGraph[numGraphPix];//values: 0-32
byte voltDisplayIndex = 0;
int leftMode = -1;
int rightMode = -1;
float volts;
int onReason = 0;//0 = ignition, 1 = tailgate, 2 = tailgate sw, 3 = switch_a, 4 = switch_b
long startAnimation = 0;
long oldPosition = 0;
boolean bedDown = false;
boolean bedSwitch = false;
boolean ill = false;
boolean switchA = false;
boolean switchB = false;
boolean tailgateToggle = false;
boolean encoderPush = false;
bool isInMenu = false;
int menuMode = 0;
bool ignoreTailgate = false;
bool editingModeLeft = false;
bool editingModeRight = false;
long lastCar = 0;

void setup() {
  bool SETUP = true;
  pinMode(LATCH_PIN, OUTPUT);
  digitalWrite(LATCH_PIN, true); //latch myself on
  pinMode(13,OUTPUT);
  digitalWrite(13, true);
  pinMode(OUTPUT0,OUTPUT);
  pinMode(OUTPUT1,OUTPUT);
  pinMode(OUTPUT2,OUTPUT);
  pinMode(OUTPUT3,OUTPUT);
  pinMode(BTATPIN, OUTPUT);
  digitalWrite(BTATPIN, SETUP);
  digitalWrite(OUTPUT0, 0);
  digitalWrite(OUTPUT1, 0);
  digitalWrite(OUTPUT2, 0);
  digitalWrite(OUTPUT3, 0);
  pinMode(VOLTAGE_INPUT,INPUT);
  pinMode(ENCODER_PUSH,INPUT_PULLUP);
  pinMode(ILL_INPUT,INPUT);
  pinMode(BED_INPUT,INPUT);
  pinMode(SWITCH_A,INPUT_PULLDOWN);
  pinMode(SWITCH_B,INPUT_PULLDOWN);
  delay(100);
  loadVariables();
  if(digitalRead(SWITCH_A))
  {
    onReason = 3;
  }
  else if(digitalRead(SWITCH_B))
  {
    onReason = 4;
  }
  else if(analogRead(BED_INPUT)>100)
  {
    onReason = 1;
  }
  else if(analogRead(BED_SWITCH)>100)
  {
    onReason = 2;
    tailgateToggle = true;
    bedSwitch = true;
  }
  for(int i = 0; i < NUMBER_OUTPUTS; i++)
  {
    outs[i] = 0;
  }
  for(int i = 0; i < numGraphPix; i++)
  {
    voltGraph[i] = 64;
  }
  //ECUinit(500000);
//  Serial2.begin(9600);
  delay(500);
  Serial.begin(9600);
  while(Serial.available()>0)
  {
    Serial.read();
  }
  if(SETUP)
  {
    BTSerial.begin(ATBAUD);
    delay(500);
    BTSerial.print("AT+RESET\r\n");
    delay(500);
  }
  else
  {
    BTSerial.begin(COMBAUD);
  }
  //delay(500);
//  setTime(getTeensy3Time());
//  debugMode = analogRead(A1)<500;
//  Serial.println(debugMode ? "DEBUG MODE":"");
  u8g2l.begin();
  u8g2l.setContrast(255);
  u8g2l.clearBuffer();
  u8g2r.begin();
  u8g2r.setContrast(255);
  u8g2r.clearBuffer();
//  if(!debugMode)
//  {
    //runLogo();
//  }
  digitalWrite(13, true);
  startAnimation = millis();
  //turnOff();
}
void loadVariables()
{
  loadModes();
  ignoreTailgate = EEPROM.read(2)==1;
}
void loadModes()
{
  leftMode = EEPROM.read(0);
  rightMode = EEPROM.read(1);
}
long lastFrame = 0;
int state = 0;
String str;
bool next = true;
long lastNext = 1000;
int time = 500;
void loop() 
{
  if(millis()-lastFrame>loopTime)
  {
    lastFrame = millis();
    //digitalWrite(13, true);
    if(volts<6 && !bedDown && leftMode!=-1 && !ill)
    {
      if(leftMode!=-2)
      {
        startAnimation = millis();
      }
      leftMode = -2;
      rightMode = -2;
    }
    else if(leftMode==-2)
    {
      loadModes();
    }
    displayLogic();
    render();
    inputLogic();
    outputsLogic();
    //digitalWrite(13, false);
    //Serial.println(millis()-lastFrame);
  }
  if(millis()-lastCar>50)
  {
    lastCar = 10000000;
    digitalWrite(13, false);
    digitalWrite(BTATPIN, false);
  }
  if(Serial.available()>0)
  {
    next = false;
    char r = Serial.read();
    Serial.write(r);
    BTSerial.write(r);
  }
  if(BTSerial.available()>0)
  {
    char c = BTSerial.read();
    if(c=='K')
    {
      time = 1000;
    }
    Serial.write(c);
  }
  if(millis()-lastNext>time && next)
    {
      lastNext = millis();
        digitalWrite(13, true);
        digitalWrite(BTATPIN, true);
        delay(50);
      //Serial.println(str);
      //if(str=="OK")
      //{
        if(state==0)
        {
          BTSerial.print("AT+RMAAD\r\n");
        }
        else if(state==1)
        {
          BTSerial.print("AT+ORGL\r\n");
        }
        else if(state==2)
        {
          BTSerial.print("AT+ROLE=1\r\n");
          state++;
        }
        else if(state==3)
        {
          BTSerial.print("AT+RESET\r\n");
          delay(100);
        }
        else if(state==4)
        {
          BTSerial.print("AT+CMODE=1\r\n");
        }
        else if(state==5)
        {
          BTSerial.print("AT+BIND=AABB,CC,112233\r\n");//AABB,CC,112233 DCDC,E2,76FB47
        }
        else if(state==6)
        {
          BTSerial.print("AT+INIT\r\n");
          Serial.println("INIT");
          time = 10000000;
        }
        else if(state==7)
        {
          BTSerial.print("AT+PAIR=AABB,CC,112233,10\r\n");
          time = 10000000;
        }
        else if(state==9)
        {
          BTSerial.print("AT+LINK=AABB,CC,112233\r\n");
          time = 10000000;
        }
        else if(state==10)
        {
          next = false;
          digitalWrite(13, false);
          digitalWrite(BTATPIN, false);
          state=9;
        }
      //}
        Serial.print(state);
      BTSerial.flush();
      lastCar = millis();
      //delay(1000);
      state++;
    }
  //delay(1);
}
